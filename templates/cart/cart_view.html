{% extends "base.html" %}
{% block title %}Cart{% endblock title %}
{% block content %}
{% include "navbar.html" %}


 <!-- Page Title -->
 <div class="page-title light-background">
  <div class="container d-lg-flex justify-content-between align-items-center">
    <h1 class="mb-2 mb-lg-0">Product Details</h1>
    <nav class="breadcrumbs">
      <ol>
        <li><a href="{% url 'Home' %}">Home</a></li>
        {% if user.is_authenticated  %}
        <li><a href='{% url "Order_status" %}'>Orders Status</a></li>
        {% else %}
        <li><a href='#'>Cart items</a></li>
        
        {% endif %}
      </ol>
    </nav>
  </div>
</div><!-- End Page Title -->


<div class="cart-container">
  {% if messages %}
<div class="messages">
  {% for message in messages %}
    <div class="alert {{ message.tags }}">
      <span>{{ message }}</span>
      <button class="close-btn" onclick="this.parentElement.style.display='none';">&times;</button>
    </div>
  {% endfor %}
</div>
{% endif %}

{% for item in cart_products %}
  {% with product=item.product quantity=item.quantity %}
    <div class="cart-item" id="cart-item-{{ product.id }}">
      <img src="{{ product.image.url }}" alt="Product" class="cart-img">
      <div class="cart-info">
        <div class="cart-name">{{ product.name }}</div>
        <div class="cart-description">{{ product.description }}</div>

        {% if product.sale %}
          <div class="cart-price">
            <strike>{{ product.price }}</strike> 
            <span style='background:rgba(136,3,3,0.7);color:white;'>10% off</span>
          </div>
          <div class="cart-price">{{ product.sale_price }}</div>
        {% else %}
          <div class="cart-price">{{ product.price }}</div>
        {% endif %}
        <div class="cart-quantity">
          <button class="qty-btn minus-btn" data-product="{{ product.id }}">&minus;</button>
           <span class="qty-num" id="qty{{product.id}}" data-value="{{ quantity }}">{{ quantity}}</span> 
          <button class="qty-btn plus-btn" data-product="{{ product.id }}">&plus;</button>
          <button class=" cart-btn update-btn update-cart" data-product="{{ product.id }}" data-index="{{ product.id }}">Update</button>

        </div>


      </div>
      <button class="cart-btn buy-btn"><a href='{% url "single_checkout" product.id %}' style='color:white;' >Buy</a></button>
      <button class="cart-btn remove-btn delete-product" data-index="{{ product.id }}">Delete</button>
    </div>
  {% endwith %}
{% empty %}
<center>
  <p>Your Cart is empty</p>
  <p>Click here to  <a href="{% url 'Home' %}">Shop now</a></p>
</center>
  {% endfor %}

<div class="subtotal-card">
  <div class="subtotal-row total">
    <span class="label">Total Amount:</span>
    {% if totals == 0 %}
    <span class="value" id="total-amount">&#8377; 0</span>

    {% else %}
    <span class="value" id="total-amount">&#8377; {{totals}}</span>
    {% endif %}
  </div>
  <a href='{% url "checkout" %}' style="
    width:100%;background:green;text-align:center;color:white;border-radius:5px;
  ">Checkout</a>

  
</div>
</div>



<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
  //quantity changing buttons 
  $(document).ready(function(){

// When plus button is clicked
$(".plus-btn").click(function(){
    let productId = $(this).data("product"); // get product id
    let qtyElement = $("#qty" + productId);  // select span by id
    let currentQty = parseInt(qtyElement.text()); // current value
    qtyElement.text(currentQty + 1); // increase
});

// When minus button is clicked
$(".minus-btn").click(function(){
    let productId = $(this).data("product");
    let qtyElement = $("#qty" + productId);
    let currentQty = parseInt(qtyElement.text());
    if(currentQty > 1){ // prevent going below 1
        qtyElement.text(currentQty - 1);
    }
});

});


  // Update Cart
  $(document).on('click', '.update-cart', function(e){
      e.preventDefault();
      // grab the product id
      var productid = $(this).data('index');
  
      $.ajax({
      type: 'POST',
      url: "{% url 'cart_update' %}",
      data: {
        product_id: $(this).data('index'),
        product_qty: $('#qty'+ productid ).text(),
        csrfmiddlewaretoken: '{{ csrf_token }}',
        action: 'post'
      },
      success: function(json){
          //console.log(json)
          //document.getElementById("cart_quantity").textContent = json.qty
          location.reload();
      },
  
      error: function(xhr, errmsg, err){
        console.log(err);
        
  
      }
  
  
      });
  
  })

 

  // Delete Item From Cart
  $(document).on('click', '.delete-product', function(e){
      e.preventDefault();
      // grab the product id
      var productid = $(this).data('index');
  
      $.ajax({
      type: 'POST',
      url: "{% url 'cart_delete' %}",
      data: {
        product_id: productid,
        csrfmiddlewaretoken: '{{ csrf_token }}',
        action: 'post'
      },
      success: function(json){
          //console.log(json)
          //document.getElementById("cart_quantity").textContent = json.qty
          location.reload();
      },
  
      error: function(xhr, errmsg, err){
        console.log(errmsg)
  
      }
  
  
      });
  
  })
  
  
  
  
  </script>

{% endblock %}
